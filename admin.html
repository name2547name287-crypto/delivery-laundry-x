<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="css/app.css">
<link rel="icon" href="data:,">
<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #0f0f0f;
  color: #fff;
  padding: 16px;
}

h2, h3 {
  margin-top: 20px;
}

.order {
  background: linear-gradient(145deg, #1a1a1a, #121212);
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,.45);
}

.order .name {
  font-weight: bold;
  font-size: 16px;
}

.order .sub {
  font-size: 13px;
  opacity: .8;
}

.order .btns {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.order button {
  border: none;
  border-radius: 10px;
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
}

.btn-pickup { background: #2563eb; }
.btn-wash { background: #059669; }
.btn-send { background: #d97706; }
.btn-done { background: #16a34a; }

</style>
</head>

<body>

<h2>ğŸ“Š Admin Dashboard</h2>

<h3>âš™ï¸ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š</h3>

<input id="cfgRadius" placeholder="à¸£à¸±à¸¨à¸¡à¸µà¸šà¸£à¸´à¸à¸²à¸£ (à¹€à¸¡à¸•à¸£)">
<input id="cfgPrice" placeholder="à¸£à¸²à¸„à¸²à¸•à¹ˆà¸­à¸à¸´à¹‚à¸¥">
<input id="cfgNight" placeholder="à¸„à¹ˆà¸²à¸£à¸­à¸šà¸”à¸¶à¸">

<button onclick="saveConfig()">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸</button>


<h3>ğŸ“¦ à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™</h3>
<div id="currentOrders"></div>

<h3>ğŸ“ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ</h3>
<div id="historyOrders"></div>


<h3>ğŸ“ˆ à¸ªà¸–à¸´à¸•à¸´</h3 >

<div class="stat-box">
  <div>ğŸ“¦ à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: <span id="totalOrder">0</span></div>
  <div>ğŸ’° à¸£à¸²à¸¢à¹„à¸”à¹‰à¸£à¸§à¸¡: <span id="totalIncome">0</span> à¸šà¸²à¸—</div>
</div>

<div id="adminOrders">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1fTECPU9pSqKwV4bff8VwSxqYEuGsUPI&libraries=geometry&callback=initMap"
  async

></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>

<script>
auth.onAuthStateChanged(async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  // ğŸ” à¹€à¸Šà¹‡à¸ role
  const uSnap = await db.collection("users").doc(user.uid).get();
  if (!uSnap.exists || uSnap.data().role !== "admin") {
    alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸² Admin");
    location.href = "index.html";
    return;
  }

  loadOrders();
});

async function loadOrders() {
  const snap = await db.collection("orders")
    .orderBy("createdAt", "desc")
    .get();

  const cur = document.getElementById("currentOrders");
  const his = document.getElementById("historyOrders");
  const box = document.getElementById("adminOrders");

  cur.innerHTML = "";
  his.innerHTML = "";
  box.innerHTML = "";

  let total = 0;
  document.getElementById("totalOrder").innerText = snap.size;

  snap.forEach(doc => {
    const o = doc.data();
    total += o.price || 0;

const mapLink =
  typeof o.lat === "number" && typeof o.lng === "number"
    ? `https://www.google.com/maps/search/?api=1&query=${o.lat},${o.lng}`
    : null;


const html = `
  <div class="order">
    <div class="name">ğŸ‘¤ ${o.username || "-"}</div>
    <div class="sub">ğŸ“ ${o.phone || "-"}</div>
    <div>ğŸ“ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”: ${o.note || "-"}</div>


    <div class="sub">ğŸ§º ${o.weight} kg | ğŸ’° ${o.price} à¸šà¸²à¸—</div>
    <div class="sub">ğŸ“Œ à¸ªà¸–à¸²à¸™à¸°: ${o.status}</div>

    <div class="sub" style="margin-top:4px">
      ğŸ“ ${
        mapLink
          ? `<a href="${mapLink}" target="_blank">à¹€à¸›à¸´à¸”à¹à¸œà¸™à¸—à¸µà¹ˆ</a>`
          : "à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸´à¸à¸±à¸”"
      }
    </div>

    <div class="btns">
      <button class="btn-pickup" onclick="updateStatus('${doc.id}','pickup')">à¸£à¸±à¸šà¸œà¹‰à¸²</button>
      <button class="btn-wash" onclick="updateStatus('${doc.id}','washing')">à¸‹à¸±à¸</button>
      <button class="btn-send" onclick="updateStatus('${doc.id}','delivering')">à¸ªà¹ˆà¸‡</button>
      <button class="btn-done" onclick="updateStatus('${doc.id}','done')">à¹€à¸ªà¸£à¹‡à¸ˆ</button>
    </div>
  </div>
`;    

    if (o.status === "done") his.innerHTML += html;
    else cur.innerHTML += html;

    box.innerHTML += html;
  });

  document.getElementById("totalIncome").innerText = total;
}

// ğŸ” à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ
function updateStatus(orderId, status) {
  db.collection("orders").doc(orderId).update({
    status: status
  }).then(() => {
    alert("à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹à¸¥à¹‰à¸§");
    loadOrders();
  });
}

async function saveConfig() {
  await db.collection("config").doc("app").set({
    serviceRadius: Number(cfgRadius.value),
    pricePerKg: Number(cfgPrice.value),
    nightFee: Number(cfgNight.value)
  });
  alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§");
}
// à¹‚à¸«à¸¥à¸”à¸„à¹ˆà¸²à¸•à¸±à¹‰à¸‡à¸•à¹‰à¸™

</script>

</body>

</html>