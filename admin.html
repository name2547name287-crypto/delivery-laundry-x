<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="css/app.css">
<link rel="icon" href="data:,">
<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #0f0f0f;
  color: #fff;
  padding: 16px;
}

h2, h3 {
  margin-top: 20px;
}

.order {
  background: linear-gradient(145deg, #1a1a1a, #121212);
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,.45);
}

.order .name {
  font-weight: bold;
  font-size: 16px;
}

.order .sub {
  font-size: 13px;
  opacity: .8;
}

.order .btns {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.order button {
  border: none;
  border-radius: 10px;
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
}

.btn-pickup { background: #2563eb; }
.btn-wash { background: #059669; }
.btn-send { background: #d97706; }
.btn-done { background: #16a34a; }

.order-card {
  background: #fff;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,.1);
}

.order-card button {
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  background: #d32f2f;
  color: #fff;
}

</style>
</head>

<body>

<h2>üìä Admin Dashboard</h2>

<h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>

<h3>üß∫ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)</h3>

<label>‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô</label>
<input id="washCold" type="number">

<label>‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡πà‡∏ô</label>
<input id="washWarm" type="number">

<label>‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô</label>
<input id="washHot" type="number">

<label>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏£‡∏≠‡∏ö)</label>
<input id="washExtraMinute" type="number">

<hr>

<label>‡∏≠‡∏ö‡∏ú‡πâ‡∏≤ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
<input id="dryBase" type="number">

<label>‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° /10 ‡∏ô‡∏≤‡∏ó‡∏µ</label>
<input id="dryPer10" type="number">

<hr>

<label>‡∏û‡∏±‡∏ö‡∏ú‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)</label>
<input id="foldPerKg" type="number">

<button onclick="saveLaundryPricing()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏±‡∏Å</button>

<h3>üöö ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)</h3>

<input id="cfgRadius" placeholder="‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡πÄ‡∏°‡∏ï‡∏£)">
<input id="cfgPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•">
<input id="cfgNight" placeholder="‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏î‡∏∂‡∏Å">

<button onclick="saveConfig()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>


<h2>üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
<div id="activeOrders"></div>

<hr>

<h2>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
<div id="historyOrders"></div>



<h3>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3 >

<div class="stat-box">
  <div>üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalOrder">0</span></div>
  <div>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°: <span id="totalIncome">0</span> ‡∏ö‡∏≤‡∏ó</div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/orderAdapter.js"></script>


<script>
auth.onAuthStateChanged(async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  // üîê ‡πÄ‡∏ä‡πá‡∏Å role
  const uSnap = await db.collection("users").doc(user.uid).get();
  if (!uSnap.exists || uSnap.data().role !== "admin") {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤ Admin");
    location.href = "index.html";
    return;
  }

});

function renderLaundryDetail(order) {
  let html = "";

  if (order.wash) {
    html += `
üß∫ ‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤
- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${order.wash.machines.join(" + ")} kg
- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤: ${order.wash.extraMinute || 0} ‡∏ô‡∏≤‡∏ó‡∏µ
- ‡∏£‡∏≤‡∏Ñ‡∏≤: ${order.wash.price} ‡∏ö‡∏≤‡∏ó
<br>`;
  }

  if (order.dry) {
    html += `
üî• ‡∏≠‡∏ö‡∏ú‡πâ‡∏≤
- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${order.dry.machines.join(" + ")} kg
- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤: ${order.dry.extraMinute || 0} ‡∏ô‡∏≤‡∏ó‡∏µ
- ‡∏£‡∏≤‡∏Ñ‡∏≤: ${order.dry.price} ‡∏ö‡∏≤‡∏ó
<br>`;
  }

  html += `
üì¶ ‡∏û‡∏±‡∏ö‡∏ú‡πâ‡∏≤: ${order.foldPrice} ‡∏ö‡∏≤‡∏ó<br>
üöö ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ${order.delivery} ‡∏ö‡∏≤‡∏ó<br>
üí∞ ‡∏£‡∏ß‡∏°: ${order.total} ‡∏ö‡∏≤‡∏ó
`;

  return html;
}


// üîÅ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
function updateStatus(orderId, status) {
  db.collection("orders").doc(orderId).update({
    status: status
  }).then(() => {
    alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß");
  });
}

async function saveConfig() {
  await db.collection("config").doc("app").set({
    serviceRadius: Number(cfgRadius.value),
    pricePerKg: Number(cfgPrice.value),
    nightFee: Number(cfgNight.value)
  });
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
}
// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô

function confirmPayment(orderId) {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß?")) return;

  db.collection("orders").doc(orderId).update({
    paymentStatus: "confirmed"
  }).then(() => {
    alert("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
  });
}


function getTimeGroup(timeSlot) {
  if (!timeSlot) return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≠‡∏ö";

  const h = parseInt(timeSlot.split(":")[0]);
  if (h >= 6 && h < 12) return "‚òÄÔ∏è ‡∏£‡∏≠‡∏ö‡πÄ‡∏ä‡πâ‡∏≤";
  if (h >= 12 && h < 18) return "üå§ ‡∏£‡∏≠‡∏ö‡∏ö‡πà‡∏≤‡∏¢";
  return "üåô ‡∏£‡∏≠‡∏ö‡∏î‡∏∂‡∏Å";
}

function renderOrderCard(order) {
  console.log("PAYMENT CHECK", {
    id: order.id,
    method: order.paymentMethod,
    status: order.paymentStatus
  });

  const mapLink =
    typeof order.lat === "number"
      ? `https://www.google.com/maps?q=${order.lat},${order.lng}`
      : null;

  return `
    <div class="order">
      <div class="name">üë§ ${order.username || "-"}</div>
      <div class="sub">üìû ${order.phone || "-"}</div>
      <div>üìù ${order.note || "-"}</div>

      <div>üí≥ ${order.paymentMethod || "-"}</div>
      <div>üìå ${order.paymentStatus || "-"}</div>

      <div class="sub">
        üìÖ ${order.bookingDate || "-"} | ‚è∞ ${order.timeSlot || "-"}
      </div>

      <div class="sub">
        üß∫ ${order.weight || 0} kg | üí∞ ${order.price || 0} ‡∏ö‡∏≤‡∏ó
      </div>

      <div class="sub">üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${order.status}</div>

      <div class="sub" style="white-space:pre-line; margin-top:8px">
${renderLaundryDetail(order)}
</div>


      ${
        mapLink
          ? `<a href="${mapLink}" target="_blank">üìç ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>`
          : ""
      }

      ${
        order.paymentMethod &&
        order.paymentMethod !== "cash" &&
        order.paymentStatus !== "confirmed"
          ? `<button onclick="confirmPayment('${order.id}')"
              style="margin-top:8px;background:#22c55e;color:#fff">
              üí∞ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            </button>`
          : ""
      }

      <div class="btns">
        <button class="btn-pickup" onclick="updateStatus('${order.id}','pickup')">üöö ‡∏£‡∏±‡∏ö‡∏ú‡πâ‡∏≤</button>
        <button class="btn-wash" onclick="updateStatus('${order.id}','washing')">üßº ‡∏ã‡∏±‡∏Å</button>
        <button class="btn-send" onclick="updateStatus('${order.id}','delivering')">üì¶ ‡∏™‡πà‡∏á</button>
        <button class="btn-done" onclick="updateStatus('${order.id}','done')">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à</button>
      </div>
    </div>
  `;
}



function groupByDateAndTime(orders) {
  const groups = {};

  orders.forEach(o => {
    const date = o.bookingDate || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô";
    const time = o.timeSlot || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≠‡∏ö";

    if (!groups[date]) groups[date] = {};
    if (!groups[date][time]) groups[date][time] = [];

    groups[date][time].push(o);
  });

  return groups;
}


function loadActiveOrders() {
  db.collection("orders")
    .orderBy("bookingDate")
    .orderBy("timeSlot")
    .orderBy("createdAt", "asc")
    .onSnapshot(snapshot => {
      const box = document.getElementById("activeOrders");
      box.innerHTML = "";

      const orders = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.status !== "done") {
          orders.push({ id: doc.id, ...data });
        }
      });

      const grouped = groupByDateAndTime(orders);

      Object.keys(grouped).forEach(date => {
        box.innerHTML += `
          <h2 style="margin-top:24px">üìÖ ${date}</h2>
        `;

        Object.keys(grouped[date]).forEach(time => {
          box.innerHTML += `
            <h3 style="margin-left:12px">‚è∞ ‡∏£‡∏≠‡∏ö ${time}</h3>
          `;

          grouped[date][time].forEach(order => {
            box.innerHTML += renderOrderCard(order);
          });
        });
      });
    });
}



function loadHistoryOrders() {
  db.collection("orders")
    .where("status", "==", "done")
    .orderBy("bookingDate", "desc")
    .orderBy("timeSlot")
    .onSnapshot(snapshot => {
      const box = document.getElementById("historyOrders");
      box.innerHTML = "";

      const orders = [];
  snapshot.forEach(doc => {
  const raw = { id: doc.id, ...doc.data() };
  const order = adaptOrderForLegacy(raw);
  orders.push(order);
});


      const grouped = groupByDateAndTime(orders);

      Object.keys(grouped).forEach(date => {
        box.innerHTML += `<h3>üìÖ ${date}</h3>`;

        Object.keys(grouped[date]).forEach(time => {
          box.innerHTML += `<div style="opacity:.7">‚è∞ ${time}</div>`;

          grouped[date][time].forEach(order => {
            box.innerHTML += renderOrderCard(order);
          });
        });
      });
    });
}


function setStatus(orderId, newStatus) {
  db.collection("orders")
    .doc(orderId)
    .update({
      status: newStatus
    });
}
async function loadLaundryPricing() {
  const snap = await db.collection("pricing").doc("laundry").get();
  if (!snap.exists) return;

  const p = snap.data();

  washCold.value = p.wash.cold;
  washWarm.value = p.wash.warm;
  washHot.value = p.wash.hot;

  washExtraMinute.value = p.washExtraMinutePrice;

  dryBase.value = p.dry.base;
  dryPer10.value = p.dry.per10min;

  foldPerKg.value = p.foldPerKg;
}

async function saveLaundryPricing() {
  await db.collection("pricing").doc("laundry").update({
    wash: {
      cold: Number(washCold.value),
      warm: Number(washWarm.value),
      hot: Number(washHot.value)
    },
    washExtraMinutePrice: Number(washExtraMinute.value),
    dry: {
      base: Number(dryBase.value),
      per10min: Number(dryPer10.value)
    },
    foldPerKg: Number(foldPerKg.value)
  });

  alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
}

function renderOrderDetail(order) {
  let html = "";

  if (order.wash) {
    html += `
üß∫ ‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤
- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${order.wash.machines.join(" + ")} kg
- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤: ${order.wash.ExtraMinute || 0} ‡∏ô‡∏≤‡∏ó‡∏µ
- ‡∏£‡∏≤‡∏Ñ‡∏≤: ${order.wash.price} ‡∏ö‡∏≤‡∏ó
`;
  }

  if (order.dry) {
    html += `
üî• ‡∏≠‡∏ö‡∏ú‡πâ‡∏≤
- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${order.dry.machines.join(" + ")} kg
- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤: ${order.dry.ExtraMinute || 0} ‡∏ô‡∏≤‡∏ó‡∏µ
- ‡∏£‡∏≤‡∏Ñ‡∏≤: ${order.dry.price} ‡∏ö‡∏≤‡∏ó
`;
  }

  html += `
üì¶ ‡∏û‡∏±‡∏ö‡∏ú‡πâ‡∏≤: ${order.foldPrice} ‡∏ö‡∏≤‡∏ó
üöö ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ${order.delivery} ‡∏ö‡∏≤‡∏ó
üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${order.total} ‡∏ö‡∏≤‡∏ó
`;

  return html;
}


loadActiveOrders();
loadHistoryOrders();


</script>


</body>

</html>

