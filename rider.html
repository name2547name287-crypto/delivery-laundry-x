<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rider Dashboard</title>

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: system-ui;
}
.header {
  padding: 16px;
  font-size: 18px;
  font-weight: bold;
  background: #111;
}
.order {
  background: #1e1e1e;
  margin: 12px;
  padding: 14px;
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(0,0,0,.4);
}
.order div {
  margin-bottom: 6px;
}
.btn {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  margin-right: 6px;
}
.pickup { background: #ff9800; }
.deliver { background: #03a9f4; }
.done { background: #4caf50; }
.map {
  background: #d32f2f;
  color: #fff;
}
</style>
</head>

<body>
<div class="header">ğŸ›µ Rider Dashboard</div>

  <h2>ğŸ“¦ à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™</h2>
<div id="activeOrders"></div>

<hr>

<h2>ğŸ“œ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ</h2>
<div id="historyOrders"></div>




<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/orderAdapter.js"></script>




<script>
auth.onAuthStateChanged(async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }
 
  else {
    const snap = await db.collection("users").doc(user.uid).get();
 const role = snap.data().role;
if (role !== "rider" && role !== "admin") {
  alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²");
  location.href = "index.html";
  return;
}
 

  }

});

function renderLaundryDetail(order) {
  let html = "";

  if (order.wash) {
    html += `
ğŸ§º à¸‹à¸±à¸à¸œà¹‰à¸²
- à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡: ${order.wash.machines.join(" + ")} kg
- à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²: ${order.wash.extraMinute || 0} à¸™à¸²à¸—à¸µ
- à¸£à¸²à¸„à¸²: ${order.wash.price} à¸šà¸²à¸—
<br>`;
  }

  if (order.dry) {
    html += `
ğŸ”¥ à¸­à¸šà¸œà¹‰à¸²
- à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡: ${order.dry.machines.join(" + ")} kg
- à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²: ${order.dry.extraMinute || 0} à¸™à¸²à¸—à¸µ
- à¸£à¸²à¸„à¸²: ${order.dry.price} à¸šà¸²à¸—
<br>`;
  }

  html += `
ğŸ“¦ à¸à¸±à¸šà¸œà¹‰à¸²: ${order.foldPrice} à¸šà¸²à¸—<br>
ğŸšš à¸„à¹ˆà¸²à¸ªà¹ˆà¸‡: ${order.delivery?.fee || 0} à¸šà¸²à¸—
ğŸ’° à¸£à¸§à¸¡: ${order.total} à¸šà¸²à¸—
`;

  return html;
}


// ğŸ” à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ
function updateStatus(orderId, status) {
  db.collection("orders").doc(orderId).update({
    status: status
  }).then(() => {
    alert("à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹à¸¥à¹‰à¸§");
  });
}

async function saveConfig() {
  await db.collection("config").doc("app").set({
    serviceRadius: Number(cfgRadius.value),
    pricePerKg: Number(cfgPrice.value),
    nightFee: Number(cfgNight.value)
  });
  alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§");
}
// à¹‚à¸«à¸¥à¸”à¸„à¹ˆà¸²à¸•à¸±à¹‰à¸‡à¸•à¹‰à¸™


function getTimeGroup(timeSlot) {
  if (!timeSlot) return "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸£à¸­à¸š";

  const h = parseInt(timeSlot.split(":")[0]);
  if (h >= 6 && h < 12) return "â˜€ï¸ à¸£à¸­à¸šà¹€à¸Šà¹‰à¸²";
  if (h >= 12 && h < 18) return "ğŸŒ¤ à¸£à¸­à¸šà¸šà¹ˆà¸²à¸¢";
  return "ğŸŒ™ à¸£à¸­à¸šà¸”à¸¶à¸";
}

function renderOrderCard(order) {
  console.log("PAYMENT CHECK", {
    id: order.id,
    method: order.paymentMethod,
    status: order.paymentStatus
  });

  const mapLink =
    typeof order.lat === "number"
      ? `https://www.google.com/maps?q=${order.lat},${order.lng}`
      : null;

  return `
    <div class="order">
      <div class="name">ğŸ‘¤ ${order.username || "-"}</div>
      <div class="sub">ğŸ“ ${order.phone || "-"}</div>
      <div>ğŸ“ ${order.note || "-"}</div>

      <div>ğŸ’³ ${order.paymentMethod || "-"}</div>
      <div>ğŸ“Œ ${order.paymentStatus || "-"}</div>

      <div class="sub">
        ğŸ“… ${order.bookingDate || "-"} | â° ${order.timeSlot || "-"}
      </div>

      <div class="sub">ğŸ“Œ à¸ªà¸–à¸²à¸™à¸°: ${order.status}</div>
           
      <div class="sub" style="white-space:pre-line; margin-top:8px">
${renderLaundryDetail(order)}</div>

<div class="order-pay">ğŸ’³ ${payText(order.paymentStatus)}</div>
      ${
        mapLink
          ? `<a href="${mapLink}" target="_blank">ğŸ“ à¹€à¸›à¸´à¸”à¹à¸œà¸™à¸—à¸µà¹ˆ</a>`
          : ""
      }

      <div class="btns">
        <button class="btn-pickup" onclick="updateStatus('${order.id}','pickup')">ğŸšš à¸£à¸±à¸šà¸œà¹‰à¸²</button>
        <button class="btn-wash" onclick="updateStatus('${order.id}','washing')">ğŸ§¼ à¸‹à¸±à¸</button>
        <button class="btn-send" onclick="updateStatus('${order.id}','delivering')">ğŸ“¦ à¸ªà¹ˆà¸‡</button>
        <button class="btn-done" onclick="updateStatus('${order.id}','done')">âœ… à¹€à¸ªà¸£à¹‡à¸ˆ</button>
      </div>
    </div>
  `;
}


function groupByDateAndTime(orders) {
  const groups = {};

  orders.forEach(o => {
    const date = o.bookingDate || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸§à¸±à¸™";
    const time = o.timeSlot || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸£à¸­à¸š";

    if (!groups[date]) groups[date] = {};
    if (!groups[date][time]) groups[date][time] = [];

    groups[date][time].push(o);
  });

  return groups;
}


function loadActiveOrders() {
  db.collection("orders")
    .orderBy("bookingDate")
    .orderBy("timeSlot")
    .orderBy("createdAt", "asc")
    .onSnapshot(snapshot => {
      const box = document.getElementById("activeOrders");
      box.innerHTML = "";

      const orders = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.status !== "done") {
          orders.push({ id: doc.id, ...data });
        }
      });

      const grouped = groupByDateAndTime(orders);

      Object.keys(grouped).forEach(date => {
        box.innerHTML += `
          <h2 style="margin-top:24px">ğŸ“… ${date}</h2>
        `;

        Object.keys(grouped[date]).forEach(time => {
          box.innerHTML += `
            <h3 style="margin-left:12px">â° à¸£à¸­à¸š ${time}</h3>
          `;

          grouped[date][time].forEach(order => {
            box.innerHTML += renderOrderCard(order);
          });
        });
      });
    });
}
   
 
function loadHistoryOrders() {
  db.collection("orders")
    .where("status", "==", "done")
    .orderBy("bookingDate", "desc")
    .orderBy("timeSlot")
    .onSnapshot(snapshot => {
      const box = document.getElementById("historyOrders");
      box.innerHTML = "";

      const orders = [];
   snapshot.forEach(doc => {
  const raw = { id: doc.id, ...doc.data() };
  const order = adaptOrderForLegacy(raw);
  orders.push(order);
});



      const grouped = groupByDateAndTime(orders);

      Object.keys(grouped).forEach(date => {
        box.innerHTML += `<h3>ğŸ“… ${date}</h3>`;

        Object.keys(grouped[date]).forEach(time => {
          box.innerHTML += `<div style="opacity:.7">â° ${time}</div>`;

          grouped[date][time].forEach(order => {
            box.innerHTML += renderOrderCard(order);
          });
        });
      });
    });
}

function payText(status) {
  if (status === "unpaid") return "âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸Šà¸³à¸£à¸°";
  if (status === "paid") return "â³ à¸£à¸­à¹à¸­à¸”à¸¡à¸´à¸™à¸¢à¸·à¸™à¸¢à¸±à¸™";
  if (status === "confirmed") return "âœ… à¸Šà¸³à¸£à¸°à¹à¸¥à¹‰à¸§";
  return "-";
}


function renderOrderDetail(order) {
  let html = "";

  if (order.wash) {
    html += `
ğŸ§º à¸‹à¸±à¸à¸œà¹‰à¸²
- à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡: ${order.wash.machines.join(" + ")} kg
- à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²: ${order.wash.ExtraMinute || 0} à¸™à¸²à¸—à¸µ
- à¸£à¸²à¸„à¸²: ${order.wash.price} à¸šà¸²à¸—
`;
  }

  if (order.dry) {
    html += `
ğŸ”¥ à¸­à¸šà¸œà¹‰à¸²
- à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡: ${order.dry.machines.join(" + ")} kg
- à¹€à¸à¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸²: ${order.dry.ExtraMinute || 0} à¸™à¸²à¸—à¸µ
- à¸£à¸²à¸„à¸²: ${order.dry.price} à¸šà¸²à¸—
`;
  }

  html += `
ğŸ“¦ à¸à¸±à¸šà¸œà¹‰à¸²: ${order.foldPrice} à¸šà¸²à¸—
ğŸšš à¸„à¹ˆà¸²à¸ªà¹ˆà¸‡: ${order.delivery?.fee || 0} à¸šà¸²à¸—
ğŸ’° à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: ${order.total} à¸šà¸²à¸—
`;

  return html;
}

loadActiveOrders();
loadHistoryOrders();


</script>

</body>

</html>

